<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cardiac Cycle Journey</title>
    <script type="text/javascript" src="https://static.sketchfab.com/api/sketchfab-viewer-1.12.1.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0d0d12;
            --bg-secondary: #13131a;
            --bg-card: #1a1a24;
            --accent-blood: #dc2626;
            --accent-oxygen: #3b82f6;
            --accent-gold: #f59e0b;
            --accent-purple: #8b5cf6;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --success: #10b981;
            --error: #ef4444;
            --border: rgba(255,255,255,0.08);
        }

        body {
            font-family: 'Crimson Pro', Georgia, serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Animated Background */
        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: 
                radial-gradient(ellipse at 30% 20%, rgba(220, 38, 38, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 70% 80%, rgba(59, 130, 246, 0.06) 0%, transparent 50%);
        }

        /* Navigation */
        .nav-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: rgba(13, 13, 18, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
        }

        .nav-tabs {
            display: flex;
            justify-content: center;
            max-width: 700px;
            margin: 0 auto;
        }

        .nav-tab {
            flex: 1;
            padding: 18px 30px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-family: 'Space Mono', monospace;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .nav-tab::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 2px;
            background: var(--accent-blood);
            transition: width 0.3s ease;
        }

        .nav-tab.active {
            color: var(--text-primary);
        }

        .nav-tab.active::after {
            width: 60%;
        }

        /* Main Content */
        .main-content {
            padding-top: 70px;
            min-height: 100vh;
        }

        .page {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Quiz Page */
        .quiz-page {
            display: grid;
            grid-template-columns: 1.3fr 1fr;
            min-height: calc(100vh - 70px);
        }

        /* Viewer Panel */
        .viewer-panel {
            position: relative;
            background: var(--bg-secondary);
        }

        #api-frame {
            width: 100%;
            height: 100%;
            border: none;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
            transition: opacity 0.5s ease;
        }

        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loader {
            width: 60px;
            height: 60px;
            border: 3px solid rgba(220, 38, 38, 0.2);
            border-top-color: var(--accent-blood);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 20px;
            font-family: 'Space Mono', monospace;
            color: var(--text-muted);
        }

        /* Hint overlay */
        .hint-overlay {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(245, 158, 11, 0.95);
            color: var(--bg-primary);
            padding: 15px 20px;
            border-radius: 10px;
            font-weight: 600;
            display: none;
            align-items: center;
            gap: 10px;
            z-index: 50;
        }

        .hint-overlay.show {
            display: flex;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Story Panel */
        .story-panel {
            padding: 50px 40px;
            display: flex;
            flex-direction: column;
            background: var(--bg-card);
            border-left: 1px solid var(--border);
            overflow-y: auto;
        }

        /* Progress */
        .progress-container {
            margin-bottom: 40px;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-family: 'Space Mono', monospace;
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .progress-bar {
            height: 4px;
            background: var(--bg-primary);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-blood), var(--accent-purple));
            border-radius: 2px;
            transition: width 0.5s ease;
        }

        /* Story Content */
        .story-phase {
            font-family: 'Space Mono', monospace;
            font-size: 0.8rem;
            color: var(--accent-gold);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 15px;
        }

        .story-title {
            font-size: 1.9rem;
            font-weight: 700;
            line-height: 1.3;
            margin-bottom: 20px;
        }

        .story-narrative {
            font-size: 1.15rem;
            line-height: 1.8;
            color: var(--text-secondary);
            margin-bottom: 25px;
            min-height: 100px;
        }

        .story-instruction {
            font-size: 1.05rem;
            color: var(--text-primary);
            padding: 18px 22px;
            background: rgba(245, 158, 11, 0.1);
            border-left: 3px solid var(--accent-gold);
            border-radius: 0 10px 10px 0;
            margin-bottom: 25px;
        }

        .story-instruction .highlight {
            color: var(--accent-gold);
            font-weight: 700;
        }

        .annotation-hint {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-top: 10px;
            font-style: italic;
        }

        /* Feedback */
        .feedback-box {
            padding: 18px 22px;
            border-radius: 10px;
            min-height: 60px;
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(255,255,255,0.02);
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .feedback-box.correct {
            background: rgba(16, 185, 129, 0.15);
            border-color: var(--success);
        }

        .feedback-box.wrong {
            background: rgba(239, 68, 68, 0.15);
            border-color: var(--error);
        }

        .feedback-icon {
            font-size: 1.4rem;
        }

        .feedback-text {
            font-size: 1rem;
            color: var(--text-secondary);
        }

        .feedback-box.correct .feedback-text { color: var(--success); }
        .feedback-box.wrong .feedback-text { color: var(--error); }

        /* Stats */
        .stats-row {
            display: flex;
            gap: 25px;
            margin-top: auto;
            padding-top: 25px;
            border-top: 1px solid var(--border);
        }

        .stat-item { flex: 1; }

        .stat-label {
            font-family: 'Space Mono', monospace;
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .stat-value.score { color: var(--success); }
        .stat-value.time { color: var(--accent-purple); }
        .stat-value.streak { color: var(--accent-gold); }

        /* Leaderboard Page */
        .leaderboard-page {
            max-width: 700px;
            margin: 0 auto;
            padding: 50px 30px;
        }

        .leaderboard-header {
            text-align: center;
            margin-bottom: 50px;
        }

        .leaderboard-header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, var(--accent-gold), var(--accent-blood));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Podium */
        .podium {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 15px;
            margin-bottom: 50px;
        }

        .podium-place {
            text-align: center;
            flex: 1;
            max-width: 140px;
        }

        .podium-avatar {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            background: var(--bg-card);
            border: 3px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-size: 1.4rem;
        }

        .podium-place:nth-child(2) .podium-avatar {
            width: 70px;
            height: 70px;
            border-color: var(--accent-gold);
            font-size: 1.8rem;
        }

        .podium-name {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .podium-score {
            font-family: 'Space Mono', monospace;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .podium-stand {
            margin-top: 12px;
            border-radius: 8px 8px 0 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            font-weight: 700;
            color: rgba(255,255,255,0.3);
        }

        .podium-place:nth-child(1) .podium-stand { height: 55px; background: linear-gradient(180deg, #71717a, #52525b); }
        .podium-place:nth-child(2) .podium-stand { height: 80px; background: linear-gradient(180deg, var(--accent-gold), #b45309); }
        .podium-place:nth-child(3) .podium-stand { height: 40px; background: linear-gradient(180deg, #a78bfa, #7c3aed); }

        /* Leaderboard Table */
        .leaderboard-table {
            background: var(--bg-card);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .leaderboard-row {
            display: flex;
            align-items: center;
            padding: 16px 22px;
            border-bottom: 1px solid var(--border);
        }

        .leaderboard-row:last-child { border-bottom: none; }

        .rank {
            width: 35px;
            font-family: 'Space Mono', monospace;
            font-weight: 700;
            color: var(--text-muted);
        }

        .player-info {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .player-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--bg-primary);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .player-name { font-weight: 600; }

        .player-score {
            font-family: 'Space Mono', monospace;
            color: var(--success);
            font-weight: 700;
        }

        .player-time {
            font-family: 'Space Mono', monospace;
            color: var(--text-muted);
            font-size: 0.85rem;
            width: 70px;
            text-align: right;
        }

        /* Score Entry */
        .score-entry {
            margin-top: 30px;
            padding: 25px;
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--accent-gold);
            display: none;
        }

        .score-entry.show { display: block; }

        .score-entry h3 {
            font-family: 'Space Mono', monospace;
            font-size: 0.8rem;
            color: var(--accent-gold);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 15px;
        }

        .name-input-row {
            display: flex;
            gap: 12px;
        }

        .name-input {
            flex: 1;
            padding: 14px 18px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'Crimson Pro', serif;
            font-size: 1.1rem;
        }

        .name-input:focus {
            outline: none;
            border-color: var(--accent-gold);
        }

        .submit-btn {
            padding: 14px 28px;
            background: var(--accent-gold);
            border: none;
            border-radius: 8px;
            color: var(--bg-primary);
            font-family: 'Space Mono', monospace;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }

        .submit-btn:hover {
            background: #d97706;
        }

        /* Discovery Page */
        .discovery-page {
            display: grid;
            grid-template-columns: 1.3fr 1fr;
            min-height: calc(100vh - 70px);
        }

        .discovery-panel {
            padding: 40px;
            background: var(--bg-card);
            border-left: 1px solid var(--border);
            overflow-y: auto;
        }

        .discovery-panel h2 {
            margin-bottom: 15px;
        }

        .discovery-panel p {
            color: var(--text-secondary);
            margin-bottom: 25px;
            line-height: 1.7;
        }

        .annotation-list {
            background: var(--bg-primary);
            border-radius: 10px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
        }

        .annotation-item {
            padding: 12px 15px;
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 3px solid var(--accent-oxygen);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .annotation-item:hover {
            background: rgba(255,255,255,0.06);
            transform: translateX(5px);
        }

        .annotation-item .click-hint {
            font-size: 0.7rem;
            color: var(--accent-gold);
            margin-top: 5px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .annotation-item:hover .click-hint {
            opacity: 1;
        }

        /* Hint Button */
        .hint-btn {
            width: 100%;
            padding: 14px 20px;
            margin-bottom: 20px;
            background: rgba(139, 92, 246, 0.15);
            border: 1px solid var(--accent-purple);
            border-radius: 8px;
            color: var(--accent-purple);
            font-family: 'Space Mono', monospace;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .hint-btn:hover {
            background: rgba(139, 92, 246, 0.25);
            transform: translateY(-2px);
        }

        .hint-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
        }

        .hint-btn.used {
            background: rgba(100, 116, 139, 0.15);
            border-color: var(--text-muted);
            color: var(--text-muted);
        }

        .annotation-item .index {
            font-family: 'Space Mono', monospace;
            font-size: 0.75rem;
            color: var(--accent-gold);
            margin-bottom: 5px;
        }

        .annotation-item .title {
            font-weight: 600;
            margin-bottom: 3px;
        }

        .annotation-item .desc {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        /* Completion Overlay */
        .completion-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(13, 13, 18, 0.98);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            flex-direction: column;
            text-align: center;
            padding: 40px;
        }

        .completion-overlay.show {
            display: flex;
            animation: fadeIn 0.5s ease;
        }

        .completion-icon {
            font-size: 5rem;
            margin-bottom: 25px;
        }

        .completion-title {
            font-size: 2.8rem;
            font-weight: 700;
            margin-bottom: 15px;
            background: linear-gradient(135deg, var(--success), var(--accent-oxygen));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .completion-subtitle {
            font-size: 1.2rem;
            color: var(--text-secondary);
            margin-bottom: 35px;
        }

        .completion-stats {
            display: flex;
            gap: 45px;
            margin-bottom: 40px;
        }

        .completion-stat-value {
            font-size: 2.8rem;
            font-weight: 700;
            display: block;
        }

        .completion-stat-label {
            font-family: 'Space Mono', monospace;
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .completion-actions {
            display: flex;
            gap: 15px;
        }

        .completion-btn {
            padding: 15px 35px;
            border-radius: 10px;
            font-family: 'Space Mono', monospace;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .completion-btn.primary {
            background: var(--accent-gold);
            border: none;
            color: var(--bg-primary);
        }

        .completion-btn.secondary {
            background: transparent;
            border: 2px solid var(--border);
            color: var(--text-primary);
        }

        .completion-btn:hover {
            transform: translateY(-2px);
        }

        /* Start Overlay */
        .start-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            flex-direction: column;
            text-align: center;
            padding: 40px;
        }

        .start-overlay.hidden { display: none; }

        .start-icon {
            font-size: 5rem;
            margin-bottom: 25px;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .start-title {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 15px;
            background: linear-gradient(135deg, var(--accent-blood), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .start-subtitle {
            font-size: 1.25rem;
            color: var(--text-secondary);
            margin-bottom: 40px;
            max-width: 500px;
            line-height: 1.6;
        }

        .start-btn {
            padding: 18px 50px;
            background: linear-gradient(135deg, var(--accent-blood), #b91c1c);
            border: none;
            border-radius: 12px;
            color: white;
            font-family: 'Space Mono', monospace;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .start-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(220, 38, 38, 0.3);
        }

        /* Server Required Notice */
        .server-notice {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            z-index: 9999;
            padding: 40px;
            overflow-y: auto;
        }

        .server-notice.show { display: block; }

        .server-box {
            max-width: 600px;
            margin: 50px auto;
            background: var(--bg-card);
            border-radius: 16px;
            padding: 40px;
            border: 1px solid var(--border);
        }

        .server-box h1 {
            color: var(--accent-gold);
            margin-bottom: 20px;
        }

        .server-box p {
            color: var(--text-secondary);
            line-height: 1.7;
            margin-bottom: 15px;
        }

        .server-box code {
            background: var(--bg-primary);
            padding: 3px 8px;
            border-radius: 4px;
            font-family: 'Space Mono', monospace;
            color: var(--accent-oxygen);
        }

        .server-box .code-block {
            background: var(--bg-primary);
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            font-family: 'Space Mono', monospace;
            color: var(--success);
        }

        /* Responsive */
        @media (max-width: 1000px) {
            .quiz-page, .discovery-page {
                grid-template-columns: 1fr;
                grid-template-rows: 50vh auto;
            }

            .completion-stats {
                flex-direction: column;
                gap: 20px;
            }
        }
    </style>
</head>
<body>

<div class="bg-animation"></div>

<!-- Server Required Notice -->
<div class="server-notice" id="server-notice">
    <div class="server-box">
        <h1>‚ö†Ô∏è Local Server Required</h1>
        <p>Sketchfab API requires running from a web server.</p>
        <p>Quick start with Python:</p>
        <div class="code-block">python -m http.server 8000</div>
        <p>Then open: <code>http://localhost:8000</code></p>
    </div>
</div>

<!-- Start Overlay -->
<div class="start-overlay" id="start-overlay">
    <div class="start-icon">ü´Ä</div>
    <h1 class="start-title">Cardiac Cycle Journey</h1>
    <p class="start-subtitle">Explore the human heart in 3D. Click on the annotations to trace the path of blood through the cardiac cycle.</p>
    <button class="start-btn" id="start-btn">Begin Journey</button>
</div>

<!-- Navigation -->
<nav class="nav-container">
    <div class="nav-tabs">
        <button class="nav-tab active" data-page="quiz">üéÆ Quiz</button>
        <button class="nav-tab" data-page="leaderboard">üèÜ Leaderboard</button>
        <button class="nav-tab" data-page="discovery">üîç Annotations</button>
    </div>
</nav>

<!-- Main Content -->
<main class="main-content">

    <!-- Quiz Page -->
    <div class="page active" id="page-quiz">
        <div class="quiz-page">
            <div class="viewer-panel">
                <div class="loading-overlay" id="loading">
                    <div class="loader"></div>
                    <p class="loading-text">Loading 3D Heart Model...</p>
                </div>
                <iframe id="api-frame" 
                        allow="autoplay; fullscreen; xr-spatial-tracking"
                        allowfullscreen
                        mozallowfullscreen="true"
                        webkitallowfullscreen="true">
                </iframe>
                <div class="hint-overlay" id="hint-overlay">
                    <span>üí°</span>
                    <span id="hint-text">Look for the numbered annotation on the model</span>
                </div>
            </div>

            <div class="story-panel">
                <div class="progress-container">
                    <div class="progress-label">
                        <span>Journey Progress</span>
                        <span id="progress-text">0 / 6</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                    </div>
                </div>

                <div class="story-phase" id="story-phase">Chapter 1</div>
                <h2 class="story-title" id="story-title">Loading...</h2>
                <p class="story-narrative" id="story-narrative">Please wait while the 3D model loads...</p>
                <div class="story-instruction" id="story-instruction">
                    <span class="highlight">Click</span> on the correct annotation in the 3D model.
                </div>
                
                <button class="hint-btn" id="hint-btn">üí° Show Hint (Move camera to target)</button>

                <div class="feedback-box" id="feedback">
                    <span class="feedback-icon"></span>
                    <span class="feedback-text">Click an annotation on the 3D model to answer</span>
                </div>

                <div class="stats-row">
                    <div class="stat-item">
                        <div class="stat-label">Score</div>
                        <div class="stat-value score" id="score">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Time</div>
                        <div class="stat-value time" id="timer">0:00</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Streak</div>
                        <div class="stat-value streak" id="streak">0üî•</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaderboard Page -->
    <div class="page" id="page-leaderboard">
        <div class="leaderboard-page">
            <div class="leaderboard-header">
                <h1>üèÜ Leaderboard</h1>
                <p style="color: var(--text-muted);">Top performers in the Cardiac Cycle Challenge</p>
            </div>

            <div class="podium">
                <div class="podium-place">
                    <div class="podium-avatar">ü•à</div>
                    <div class="podium-name" id="p2-name">---</div>
                    <div class="podium-score" id="p2-score">-</div>
                    <div class="podium-stand">2</div>
                </div>
                <div class="podium-place">
                    <div class="podium-avatar">üëë</div>
                    <div class="podium-name" id="p1-name">---</div>
                    <div class="podium-score" id="p1-score">-</div>
                    <div class="podium-stand">1</div>
                </div>
                <div class="podium-place">
                    <div class="podium-avatar">ü•â</div>
                    <div class="podium-name" id="p3-name">---</div>
                    <div class="podium-score" id="p3-score">-</div>
                    <div class="podium-stand">3</div>
                </div>
            </div>

            <div class="leaderboard-table" id="leaderboard-table"></div>

            <div class="score-entry" id="score-entry">
                <h3>üéâ Submit Your Score</h3>
                <div class="name-input-row">
                    <input type="text" class="name-input" id="player-name" placeholder="Enter your name..." maxlength="20">
                    <button class="submit-btn" id="submit-btn">Submit</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Discovery Page -->
    <div class="page" id="page-discovery">
        <div class="discovery-page">
            <div class="viewer-panel">
                <iframe id="discovery-frame"
                        allow="autoplay; fullscreen; xr-spatial-tracking"
                        allowfullscreen
                        mozallowfullscreen="true"
                        webkitallowfullscreen="true"
                        style="width: 100%; height: 100%; border: none;">
                </iframe>
            </div>
            <div class="discovery-panel">
                <h2>üîç Model Annotations</h2>
                <p>This model has numbered annotations. Click them in the 3D viewer to learn about each heart structure. The quiz will ask you to find specific annotations.</p>
                
                <h3 style="margin: 25px 0 15px; font-size: 1rem;">Available Annotations</h3>
                <div class="annotation-list" id="annotation-list">
                    <p style="color: var(--text-muted); text-align: center; padding: 20px;">
                        Loading annotations...
                    </p>
                </div>
            </div>
        </div>
    </div>

</main>

<!-- Completion Overlay -->
<div class="completion-overlay" id="completion-overlay">
    <div class="completion-icon">üéâ</div>
    <h1 class="completion-title">Journey Complete!</h1>
    <p class="completion-subtitle">You've traced the path of blood through the heart</p>
    
    <div class="completion-stats">
        <div>
            <span class="completion-stat-value" id="final-score" style="color: var(--success)">0</span>
            <span class="completion-stat-label">Points</span>
        </div>
        <div>
            <span class="completion-stat-value" id="final-time" style="color: var(--accent-purple)">0:00</span>
            <span class="completion-stat-label">Time</span>
        </div>
        <div>
            <span class="completion-stat-value" id="final-accuracy" style="color: var(--accent-gold)">0%</span>
            <span class="completion-stat-label">Accuracy</span>
        </div>
    </div>

    <div class="completion-actions">
        <button class="completion-btn primary" id="save-btn">Save to Leaderboard</button>
        <button class="completion-btn secondary" id="replay-btn">Play Again</button>
    </div>
</div>

<script>
    // =============================================
    // CHECK FOR FILE:// PROTOCOL
    // =============================================
    if (window.location.protocol === 'file:') {
        document.getElementById('server-notice').classList.add('show');
    }

    // =============================================
    // CONFIGURATION
    // Map annotation indices to story steps
    // You may need to adjust these based on the actual annotations
    // =============================================
    const MODEL_UID = 'a3f0ea2030214a6bbaa97e7357eebd58';
    
    // Story steps - will be populated after loading annotations
    let storySteps = [];
    let annotationData = [];

    // Fallback story if we can't read annotations
    const defaultStory = [
        {
            chapter: "Chapter 1",
            title: "The Great Vessels",
            narrative: "Blood enters and exits the heart through large vessels. The aorta carries oxygen-rich blood to the body, while the vena cava returns deoxygenated blood.",
            instruction: "Find and click the annotation for the <span class='highlight'>Aorta</span>",
            keywords: ["aorta"],
            points: 100
        },
        {
            chapter: "Chapter 2", 
            title: "The Pulmonary Circuit",
            narrative: "The pulmonary artery is unique - it carries deoxygenated blood FROM the heart TO the lungs. After gas exchange, blood returns via the pulmonary veins.",
            instruction: "Find the <span class='highlight'>Pulmonary Artery</span> annotation",
            keywords: ["pulmonary artery", "pulmonary trunk"],
            points: 100
        },
        {
            chapter: "Chapter 3",
            title: "The Coronary Circulation",
            narrative: "The heart needs its own blood supply! Coronary arteries branch from the aorta and wrap around the heart muscle, delivering oxygen to keep it beating.",
            instruction: "Click on a <span class='highlight'>Coronary Artery</span> annotation",
            keywords: ["coronary", "coronary artery"],
            points: 150
        },
        {
            chapter: "Chapter 4",
            title: "The Cardiac Veins",
            narrative: "After nourishing the heart muscle, blood drains through cardiac veins into the coronary sinus, which empties into the right atrium.",
            instruction: "Find a <span class='highlight'>Cardiac Vein</span> annotation",
            keywords: ["cardiac vein", "vein", "coronary sinus"],
            points: 150
        },
        {
            chapter: "Chapter 5",
            title: "The Atria",
            narrative: "The heart has four chambers. The atria are the upper receiving chambers - the right atrium receives deoxygenated blood, the left receives oxygenated blood from the lungs.",
            instruction: "Click on an <span class='highlight'>Atrium</span> annotation",
            keywords: ["atrium", "auricle", "right atrium", "left atrium"],
            points: 100
        },
        {
            chapter: "Chapter 6",
            title: "The Ventricles",
            narrative: "The ventricles are the powerful pumping chambers. The right ventricle sends blood to the lungs, while the muscular left ventricle pumps blood to the entire body.",
            instruction: "Find a <span class='highlight'>Ventricle</span> annotation",
            keywords: ["ventricle", "right ventricle", "left ventricle"],
            points: 100
        }
    ];

    // =============================================
    // STATE
    // =============================================
    let api = null;
    let apiDiscovery = null;
    let currentStep = 0;
    let score = 0;
    let streak = 0;
    let totalAttempts = 0;
    let correctAttempts = 0;
    let timerInterval = null;
    let elapsedSeconds = 0;
    let gameStarted = false;
    let gameComplete = false;

    // Leaderboard
    let leaderboard = JSON.parse(localStorage.getItem('cardiacLeaderboard')) || [
        { name: "Dr. Heart", score: 850, time: "1:45" },
        { name: "CardioKing", score: 780, time: "2:10" },
        { name: "BloodFlow", score: 720, time: "2:30" },
        { name: "Anatomist", score: 650, time: "2:55" },
        { name: "MedStudent", score: 600, time: "3:20" }
    ];

    // =============================================
    // DOM ELEMENTS
    // =============================================
    const startOverlay = document.getElementById('start-overlay');
    const loadingEl = document.getElementById('loading');
    const iframe = document.getElementById('api-frame');

    // =============================================
    // NAVIGATION
    // =============================================
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            
            tab.classList.add('active');
            document.getElementById(`page-${tab.dataset.page}`).classList.add('active');

            if (tab.dataset.page === 'leaderboard') {
                renderLeaderboard();
            }

            if (tab.dataset.page === 'discovery' && !apiDiscovery) {
                initDiscoveryViewer();
            }
        });
    });

    // =============================================
    // START GAME
    // =============================================
    document.getElementById('start-btn').addEventListener('click', () => {
        startOverlay.classList.add('hidden');
        initSketchfab();
    });

    // =============================================
    // SKETCHFAB API
    // =============================================
    function initSketchfab() {
        const client = new Sketchfab(iframe);

        client.init(MODEL_UID, {
            success: function(apiInstance) {
                api = apiInstance;
                console.log('‚úÖ Sketchfab API initialized');

                api.start();

                api.addEventListener('viewerready', function() {
                    console.log('‚úÖ Viewer ready');
                    loadingEl.classList.add('hidden');

                    // Get annotations
                    api.getAnnotationList(function(err, annotations) {
                        if (!err && annotations.length > 0) {
                            annotationData = annotations;
                            console.log('üìã Annotations:', annotations);
                            
                            // Display in discovery panel
                            displayAnnotations(annotations);
                            
                            // Build story from annotations or use default
                            buildStoryFromAnnotations(annotations);
                        } else {
                            console.log('Using default story');
                            storySteps = defaultStory;
                        }

                        startGame();
                    });

                    // Listen for annotation clicks
                    api.addEventListener('annotationSelect', function(index) {
                        console.log('Annotation selected:', index);
                        if (gameStarted && !gameComplete && index >= 0) {
                            checkAnnotationAnswer(index);
                        }
                    });
                });
            },
            error: function(err) {
                console.error('‚ùå Error:', err);
                loadingEl.innerHTML = '<p style="color: #ef4444;">Error loading model</p>';
            },
            autostart: 0,
            annotations_visible: 1,
            ui_animations: 0,
            ui_stop: 0,
            ui_inspector: 0,
            ui_watermark_link: 0,
            ui_watermark: 0,
            ui_hint: 1,
            ui_ar: 0,
            ui_help: 0,
            ui_settings: 0,
            ui_fullscreen: 1,
            ui_annotations: 1
        });
    }

    function displayAnnotations(annotations) {
        const listEl = document.getElementById('annotation-list');
        listEl.innerHTML = annotations.map((ann, i) => `
            <div class="annotation-item" data-index="${i}">
                <div class="index">Annotation ${i + 1}</div>
                <div class="title">${ann.name || 'Unnamed'}</div>
                <div class="desc">${ann.content?.description || ann.content?.title || ''}</div>
                <div class="click-hint">üëÜ Click to view</div>
            </div>
        `).join('');

        // Add click handlers to navigate to annotations
        listEl.querySelectorAll('.annotation-item').forEach(item => {
            item.addEventListener('click', () => {
                const index = parseInt(item.dataset.index);
                if (api) {
                    api.gotoAnnotation(index, { preventCameraAnimation: false }, function(err) {
                        if (!err) {
                            console.log('Camera moved to annotation', index);
                        }
                    });
                }
            });
        });
    }

    function buildStoryFromAnnotations(annotations) {
        // Use default story but try to match with actual annotations
        storySteps = defaultStory.map(step => {
            // Find matching annotation
            const matchingIndex = annotations.findIndex(ann => {
                const name = (ann.name || '').toLowerCase();
                const desc = (ann.content?.description || '').toLowerCase();
                return step.keywords.some(kw => name.includes(kw) || desc.includes(kw));
            });

            return {
                ...step,
                targetAnnotationIndex: matchingIndex >= 0 ? matchingIndex : null,
                targetKeywords: step.keywords
            };
        });

        console.log('Story steps with annotations:', storySteps);
    }

    // =============================================
    // GAME LOGIC
    // =============================================
    function startGame() {
        gameStarted = true;
        gameComplete = false;
        currentStep = 0;
        score = 0;
        streak = 0;
        totalAttempts = 0;
        correctAttempts = 0;
        elapsedSeconds = 0;

        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            elapsedSeconds++;
            document.getElementById('timer').textContent = formatTime(elapsedSeconds);
        }, 1000);

        updateUI();
    }

    function formatTime(sec) {
        const m = Math.floor(sec / 60);
        const s = sec % 60;
        return `${m}:${s.toString().padStart(2, '0')}`;
    }

    function checkAnnotationAnswer(selectedIndex) {
        if (currentStep >= storySteps.length) return;

        const step = storySteps[currentStep];
        const selectedAnnotation = annotationData[selectedIndex];
        const selectedName = (selectedAnnotation?.name || '').toLowerCase();
        const selectedDesc = (selectedAnnotation?.content?.description || '').toLowerCase();

        totalAttempts++;

        // Check if it matches
        let isCorrect = false;
        
        // First check if we have a specific target
        if (step.targetAnnotationIndex !== null && selectedIndex === step.targetAnnotationIndex) {
            isCorrect = true;
        } 
        // Otherwise check keywords
        else if (step.targetKeywords) {
            isCorrect = step.targetKeywords.some(kw => 
                selectedName.includes(kw) || selectedDesc.includes(kw)
            );
        }

        if (isCorrect) {
            correctAttempts++;
            streak++;

            const streakBonus = Math.min(streak - 1, 5) * 25;
            const earned = step.points + streakBonus;
            score += earned;

            showFeedback(true, `+${earned} points!${streakBonus > 0 ? ' üî• Streak bonus!' : ''}`);

            currentStep++;
            if (currentStep >= storySteps.length) {
                setTimeout(completeGame, 1000);
            } else {
                setTimeout(updateUI, 1200);
            }
        } else {
            streak = 0;
            const clickedName = selectedAnnotation?.name || `Annotation ${selectedIndex + 1}`;
            showFeedback(false, `That's "${clickedName}". Try another annotation!`);
        }

        updateStats();
    }

    function updateUI() {
        const step = storySteps[currentStep];
        document.getElementById('story-phase').textContent = step.chapter;
        document.getElementById('story-title').textContent = step.title;
        document.getElementById('story-narrative').textContent = step.narrative;
        document.getElementById('story-instruction').innerHTML = step.instruction;

        const progress = (currentStep / storySteps.length) * 100;
        document.getElementById('progress-fill').style.width = `${progress}%`;
        document.getElementById('progress-text').textContent = `${currentStep} / ${storySteps.length}`;

        resetFeedback();
        resetHintButton();
    }

    function updateStats() {
        document.getElementById('score').textContent = score;
        document.getElementById('streak').textContent = `${streak}üî•`;
    }

    function showFeedback(isCorrect, message) {
        const fb = document.getElementById('feedback');
        fb.className = 'feedback-box ' + (isCorrect ? 'correct' : 'wrong');
        fb.querySelector('.feedback-icon').textContent = isCorrect ? '‚úì' : '‚úó';
        fb.querySelector('.feedback-text').textContent = message;
    }

    function resetFeedback() {
        const fb = document.getElementById('feedback');
        fb.className = 'feedback-box';
        fb.querySelector('.feedback-icon').textContent = '';
        fb.querySelector('.feedback-text').textContent = 'Click an annotation on the 3D model';
    }

    function completeGame() {
        gameComplete = true;
        clearInterval(timerInterval);

        const accuracy = totalAttempts > 0 ? Math.round((correctAttempts / totalAttempts) * 100) : 0;

        document.getElementById('final-score').textContent = score;
        document.getElementById('final-time').textContent = formatTime(elapsedSeconds);
        document.getElementById('final-accuracy').textContent = accuracy + '%';

        document.getElementById('completion-overlay').classList.add('show');
        document.getElementById('score-entry').classList.add('show');
    }

    // =============================================
    // COMPLETION ACTIONS
    // =============================================
    document.getElementById('save-btn').addEventListener('click', () => {
        document.getElementById('completion-overlay').classList.remove('show');
        document.querySelector('[data-page="leaderboard"]').click();
    });

    document.getElementById('replay-btn').addEventListener('click', () => {
        document.getElementById('completion-overlay').classList.remove('show');
        startGame();
    });

    // =============================================
    // LEADERBOARD
    // =============================================
    function renderLeaderboard() {
        leaderboard.sort((a, b) => b.score - a.score);

        // Podium
        if (leaderboard[0]) {
            document.getElementById('p1-name').textContent = leaderboard[0].name;
            document.getElementById('p1-score').textContent = leaderboard[0].score + ' pts';
        }
        if (leaderboard[1]) {
            document.getElementById('p2-name').textContent = leaderboard[1].name;
            document.getElementById('p2-score').textContent = leaderboard[1].score + ' pts';
        }
        if (leaderboard[2]) {
            document.getElementById('p3-name').textContent = leaderboard[2].name;
            document.getElementById('p3-score').textContent = leaderboard[2].score + ' pts';
        }

        // Table
        const table = document.getElementById('leaderboard-table');
        table.innerHTML = leaderboard.slice(3).map((entry, i) => `
            <div class="leaderboard-row">
                <span class="rank">${i + 4}</span>
                <div class="player-info">
                    <div class="player-avatar">üë§</div>
                    <span class="player-name">${entry.name}</span>
                </div>
                <span class="player-score">${entry.score}</span>
                <span class="player-time">${entry.time}</span>
            </div>
        `).join('');
    }

    document.getElementById('submit-btn').addEventListener('click', () => {
        const name = document.getElementById('player-name').value.trim() || 'Anonymous';
        
        leaderboard.push({
            name: name,
            score: score,
            time: formatTime(elapsedSeconds)
        });

        localStorage.setItem('cardiacLeaderboard', JSON.stringify(leaderboard));
        
        document.getElementById('score-entry').classList.remove('show');
        document.getElementById('player-name').value = '';
        renderLeaderboard();
    });

    // Initial render
    renderLeaderboard();

    // =============================================
    // HINT BUTTON
    // =============================================
    document.getElementById('hint-btn').addEventListener('click', () => {
        if (!api || currentStep >= storySteps.length) return;

        const step = storySteps[currentStep];
        
        // Find matching annotation
        let targetIndex = step.targetAnnotationIndex;
        
        // If no specific target, search by keywords
        if (targetIndex === null || targetIndex === undefined) {
            targetIndex = annotationData.findIndex(ann => {
                const name = (ann.name || '').toLowerCase();
                const desc = (ann.content?.description || '').toLowerCase();
                return step.targetKeywords.some(kw => name.includes(kw) || desc.includes(kw));
            });
        }

        if (targetIndex >= 0) {
            // Move camera to the annotation
            api.gotoAnnotation(targetIndex, { preventCameraAnimation: false }, function(err) {
                if (!err) {
                    console.log('Hint: Camera moved to annotation', targetIndex);
                    showFeedback(false, `Hint used! This is "${annotationData[targetIndex]?.name || 'the target'}". Now click it!`);
                    
                    // Mark hint as used (optional: reduce points)
                    document.getElementById('hint-btn').classList.add('used');
                    document.getElementById('hint-btn').textContent = 'üí° Hint Used (-50 points)';
                    
                    // Deduct points for using hint
                    score = Math.max(0, score - 50);
                    updateStats();
                }
            });
        } else {
            showFeedback(false, "Hint not available for this step. Explore the model!");
        }
    });

    // Reset hint button when moving to next step
    function resetHintButton() {
        const hintBtn = document.getElementById('hint-btn');
        hintBtn.classList.remove('used');
        hintBtn.textContent = 'üí° Show Hint (Move camera to target)';
    }

    // =============================================
    // DISCOVERY VIEWER
    // =============================================
    function initDiscoveryViewer() {
        const discoveryFrame = document.getElementById('discovery-frame');
        const clientDiscovery = new Sketchfab(discoveryFrame);

        clientDiscovery.init(MODEL_UID, {
            success: function(apiInstance) {
                apiDiscovery = apiInstance;
                apiDiscovery.start();

                apiDiscovery.addEventListener('viewerready', function() {
                    console.log('‚úÖ Discovery viewer ready');

                    // Get annotations for discovery list
                    apiDiscovery.getAnnotationList(function(err, annotations) {
                        if (!err) {
                            displayAnnotationsForDiscovery(annotations);
                        }
                    });
                });
            },
            error: function(err) {
                console.error('Discovery viewer error:', err);
            },
            autostart: 1,
            annotations_visible: 1,
            ui_annotations: 1,
            ui_watermark: 0
        });
    }

    function displayAnnotationsForDiscovery(annotations) {
        const listEl = document.getElementById('annotation-list');
        listEl.innerHTML = annotations.map((ann, i) => `
            <div class="annotation-item" data-index="${i}">
                <div class="index">Annotation ${i + 1}</div>
                <div class="title">${ann.name || 'Unnamed'}</div>
                <div class="desc">${ann.content?.description || ann.content?.title || ''}</div>
                <div class="click-hint">üëÜ Click to view</div>
            </div>
        `).join('');

        // Add click handlers for discovery viewer
        listEl.querySelectorAll('.annotation-item').forEach(item => {
            item.addEventListener('click', () => {
                const index = parseInt(item.dataset.index);
                if (apiDiscovery) {
                    apiDiscovery.gotoAnnotation(index, { preventCameraAnimation: false }, function(err) {
                        if (!err) {
                            console.log('Discovery: Camera moved to annotation', index);
                        }
                    });
                }
            });
        });
    }
</script>

</body>
</html>