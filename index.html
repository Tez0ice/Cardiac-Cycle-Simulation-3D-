<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cardiac Cycle Journey - Story Mode</title>
    <script type="text/javascript" src="https://static.sketchfab.com/api/sketchfab-viewer-1.12.1.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0d0d12;
            --bg-secondary: #13131a;
            --bg-card: #1a1a24;
            --accent-blood: #dc2626;
            --accent-oxygen: #3b82f6;
            --accent-gold: #f59e0b;
            --accent-purple: #8b5cf6;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --success: #10b981;
            --error: #ef4444;
            --border: rgba(255,255,255,0.08);
        }

        body {
            font-family: 'Crimson Pro', Georgia, serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Navigation */
        .nav-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: rgba(13, 13, 18, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
        }

        .nav-tabs {
            display: flex;
            justify-content: center;
            max-width: 700px;
            margin: 0 auto;
        }

        .nav-tab {
            flex: 1;
            padding: 18px 30px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-family: 'Space Mono', monospace;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .nav-tab::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 2px;
            background: var(--accent-blood);
            transition: width 0.3s ease;
        }

        .nav-tab.active {
            color: var(--text-primary);
        }

        .nav-tab.active::after {
            width: 60%;
        }

        /* Main Content */
        .main-content {
            padding-top: 70px;
            min-height: 100vh;
        }

        .page {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Quiz Page */
        .quiz-page {
            display: grid;
            grid-template-columns: 1.3fr 1fr;
            min-height: calc(100vh - 70px);
        }

        /* Viewer Panel */
        .viewer-panel {
            position: relative;
            background: var(--bg-secondary);
        }

        #api-frame {
            width: 100%;
            height: 100%;
            border: none;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
            transition: opacity 0.5s ease;
        }

        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loader {
            width: 60px;
            height: 60px;
            border: 3px solid rgba(220, 38, 38, 0.2);
            border-top-color: var(--accent-blood);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 20px;
            font-family: 'Space Mono', monospace;
            color: var(--text-muted);
        }

        /* Critical Vignette Effect */
        .vignette-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
            opacity: 0;
            transition: opacity 0.5s ease;
            background: radial-gradient(ellipse at center, transparent 40%, rgba(220, 38, 38, 0.4) 100%);
        }

        .vignette-overlay.critical {
            opacity: 1;
            animation: vignettePulse 1s ease-in-out infinite;
        }

        @keyframes vignettePulse {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }

        /* Story Panel */
        .story-panel {
            padding: 40px 35px;
            display: flex;
            flex-direction: column;
            background: var(--bg-card);
            border-left: 1px solid var(--border);
            overflow-y: auto;
        }

        /* Oxygen/Vital Signs */
        .vital-signs {
            background: rgba(220, 38, 38, 0.08);
            border: 1px solid rgba(220, 38, 38, 0.3);
            padding: 18px;
            border-radius: 10px;
            margin-bottom: 25px;
            transition: all 0.3s ease;
        }

        .vital-signs.critical {
            background: rgba(220, 38, 38, 0.2);
            border-color: var(--error);
            animation: vitalPulse 0.8s ease-in-out infinite;
        }

        @keyframes vitalPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            50% { box-shadow: 0 0 20px 5px rgba(239, 68, 68, 0.2); }
        }

        .vital-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .vital-label {
            font-family: 'Space Mono', monospace;
            font-size: 0.75rem;
            color: var(--accent-blood);
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .vital-percent {
            font-family: 'Space Mono', monospace;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .vital-percent.low {
            color: var(--error);
        }

        .oxygen-bar-container {
            height: 8px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 4px;
            overflow: hidden;
        }

        .oxygen-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--error), var(--accent-oxygen));
            border-radius: 4px;
            transition: width 0.3s ease;
            position: relative;
        }

        .oxygen-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.3) 50%, transparent 100%);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .status-text {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 10px;
            font-style: italic;
        }

        .status-text.urgent {
            color: var(--error);
            font-weight: 600;
            font-style: normal;
        }

        /* Progress */
        .progress-container {
            margin-bottom: 25px;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-family: 'Space Mono', monospace;
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .progress-bar {
            height: 4px;
            background: var(--bg-primary);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-blood), var(--accent-purple));
            border-radius: 2px;
            transition: width 0.5s ease;
        }

        /* Story Content */
        .story-phase {
            font-family: 'Space Mono', monospace;
            font-size: 0.75rem;
            color: var(--accent-gold);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 10px;
        }

        .story-title {
            font-size: 1.8rem;
            font-weight: 700;
            line-height: 1.3;
            margin-bottom: 15px;
            min-height: 2.4rem;
        }

        .story-narrative {
            font-size: 1.1rem;
            line-height: 1.8;
            color: var(--text-secondary);
            margin-bottom: 20px;
            min-height: 80px;
        }

        .story-narrative .highlight {
            color: var(--accent-gold);
            font-weight: 600;
        }

        /* Typewriter cursor */
        .typewriter-cursor {
            display: inline-block;
            width: 2px;
            height: 1.1em;
            background: var(--accent-gold);
            margin-left: 2px;
            animation: blink 0.8s infinite;
            vertical-align: text-bottom;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        .story-instruction {
            font-size: 1rem;
            color: var(--text-primary);
            padding: 15px 18px;
            background: rgba(245, 158, 11, 0.1);
            border-left: 3px solid var(--accent-gold);
            border-radius: 0 8px 8px 0;
            margin-bottom: 20px;
        }

        .story-instruction .target {
            color: var(--accent-gold);
            font-weight: 700;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .action-btn {
            flex: 1;
            padding: 12px 15px;
            border-radius: 8px;
            font-family: 'Space Mono', monospace;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .action-btn.hint {
            background: rgba(139, 92, 246, 0.15);
            border: 1px solid var(--accent-purple);
            color: var(--accent-purple);
        }

        .action-btn.hint:hover {
            background: rgba(139, 92, 246, 0.25);
        }

        .action-btn.hint.used {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .action-btn.skip {
            background: rgba(100, 116, 139, 0.15);
            border: 1px solid var(--text-muted);
            color: var(--text-muted);
        }

        .action-btn.skip:hover {
            background: rgba(100, 116, 139, 0.25);
        }

        /* Feedback */
        .feedback-box {
            padding: 15px 18px;
            border-radius: 8px;
            min-height: 50px;
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(255,255,255,0.02);
            border: 1px solid var(--border);
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .feedback-box.correct {
            background: rgba(16, 185, 129, 0.15);
            border-color: var(--success);
        }

        .feedback-box.wrong {
            background: rgba(239, 68, 68, 0.15);
            border-color: var(--error);
        }

        .feedback-icon { font-size: 1.3rem; }
        .feedback-text { font-size: 0.95rem; color: var(--text-secondary); }
        .feedback-box.correct .feedback-text { color: var(--success); }
        .feedback-box.wrong .feedback-text { color: var(--error); }

        /* Stats */
        .stats-row {
            display: flex;
            gap: 20px;
            margin-top: auto;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }

        .stat-item { flex: 1; }

        .stat-label {
            font-family: 'Space Mono', monospace;
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.6rem;
            font-weight: 700;
        }

        .stat-value.score { color: var(--success); }
        .stat-value.time { color: var(--accent-purple); }
        .stat-value.streak { color: var(--accent-gold); }

        /* Leaderboard Page */
        .leaderboard-page {
            max-width: 700px;
            margin: 0 auto;
            padding: 50px 30px;
        }

        .leaderboard-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .leaderboard-header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, var(--accent-gold), var(--accent-blood));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Podium */
        .podium {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 12px;
            margin-bottom: 40px;
        }

        .podium-place {
            text-align: center;
            flex: 1;
            max-width: 130px;
        }

        .podium-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--bg-card);
            border: 3px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 8px;
            font-size: 1.3rem;
        }

        .podium-place:nth-child(2) .podium-avatar {
            width: 65px;
            height: 65px;
            border-color: var(--accent-gold);
            font-size: 1.6rem;
        }

        .podium-name { font-weight: 600; font-size: 0.85rem; margin-bottom: 3px; }
        .podium-score { font-family: 'Space Mono', monospace; font-size: 0.75rem; color: var(--text-muted); }

        .podium-stand {
            margin-top: 10px;
            border-radius: 6px 6px 0 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: 700;
            color: rgba(255,255,255,0.3);
        }

        .podium-place:nth-child(1) .podium-stand { height: 50px; background: linear-gradient(180deg, #71717a, #52525b); }
        .podium-place:nth-child(2) .podium-stand { height: 75px; background: linear-gradient(180deg, var(--accent-gold), #b45309); }
        .podium-place:nth-child(3) .podium-stand { height: 35px; background: linear-gradient(180deg, #a78bfa, #7c3aed); }

        /* Leaderboard Table */
        .leaderboard-table {
            background: var(--bg-card);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .leaderboard-row {
            display: flex;
            align-items: center;
            padding: 14px 20px;
            border-bottom: 1px solid var(--border);
        }

        .leaderboard-row:last-child { border-bottom: none; }

        .rank { width: 30px; font-family: 'Space Mono', monospace; font-weight: 700; color: var(--text-muted); }
        .player-info { flex: 1; display: flex; align-items: center; gap: 10px; }
        .player-avatar { width: 32px; height: 32px; border-radius: 50%; background: var(--bg-primary); display: flex; align-items: center; justify-content: center; font-size: 0.9rem; }
        .player-name { font-weight: 600; font-size: 0.95rem; }
        .player-score { font-family: 'Space Mono', monospace; color: var(--success); font-weight: 700; }
        .player-time { font-family: 'Space Mono', monospace; color: var(--text-muted); font-size: 0.8rem; width: 60px; text-align: right; }

        /* Score Entry */
        .score-entry {
            margin-top: 25px;
            padding: 22px;
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--accent-gold);
            display: none;
        }

        .score-entry.show { display: block; }

        .score-entry h3 {
            font-family: 'Space Mono', monospace;
            font-size: 0.75rem;
            color: var(--accent-gold);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
        }

        .name-input-row { display: flex; gap: 10px; }

        .name-input {
            flex: 1;
            padding: 12px 15px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'Crimson Pro', serif;
            font-size: 1rem;
        }

        .name-input:focus { outline: none; border-color: var(--accent-gold); }

        .submit-btn {
            padding: 12px 24px;
            background: var(--accent-gold);
            border: none;
            border-radius: 8px;
            color: var(--bg-primary);
            font-family: 'Space Mono', monospace;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }

        .submit-btn:hover { background: #d97706; }

        /* Discovery Page */
        .discovery-page {
            display: grid;
            grid-template-columns: 1.3fr 1fr;
            min-height: calc(100vh - 70px);
        }

        .discovery-panel {
            padding: 35px;
            background: var(--bg-card);
            border-left: 1px solid var(--border);
            overflow-y: auto;
        }

        .discovery-panel h2 { margin-bottom: 12px; }
        .discovery-panel p { color: var(--text-secondary); margin-bottom: 20px; line-height: 1.6; font-size: 0.95rem; }

        .annotation-list {
            background: var(--bg-primary);
            border-radius: 10px;
            padding: 12px;
            max-height: 450px;
            overflow-y: auto;
        }

        .annotation-item {
            padding: 12px 14px;
            background: rgba(255,255,255,0.02);
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 3px solid var(--accent-oxygen);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .annotation-item:hover {
            background: rgba(255,255,255,0.05);
            transform: translateX(4px);
        }

        .annotation-item .index { font-family: 'Space Mono', monospace; font-size: 0.7rem; color: var(--accent-gold); margin-bottom: 4px; }
        .annotation-item .title { font-weight: 600; font-size: 0.95rem; margin-bottom: 2px; }
        .annotation-item .desc { font-size: 0.8rem; color: var(--text-muted); }

        /* Game Over Overlay */
        .gameover-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(13, 13, 18, 0.98);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            flex-direction: column;
            text-align: center;
            padding: 40px;
        }

        .gameover-overlay.show {
            display: flex;
            animation: fadeIn 0.5s ease;
        }

        .gameover-icon { font-size: 5rem; margin-bottom: 20px; }

        .gameover-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--error);
        }

        .gameover-subtitle {
            font-size: 1.1rem;
            color: var(--text-secondary);
            margin-bottom: 35px;
            max-width: 400px;
        }

        .gameover-btn {
            padding: 16px 40px;
            background: var(--accent-blood);
            border: none;
            border-radius: 10px;
            color: white;
            font-family: 'Space Mono', monospace;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }

        .gameover-btn:hover { transform: translateY(-3px); }

        /* Completion Overlay */
        .completion-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(13, 13, 18, 0.98);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            flex-direction: column;
            text-align: center;
            padding: 40px;
        }

        .completion-overlay.show {
            display: flex;
            animation: fadeIn 0.5s ease;
        }

        .completion-icon { font-size: 5rem; margin-bottom: 20px; }

        .completion-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 12px;
            background: linear-gradient(135deg, var(--success), var(--accent-oxygen));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .completion-subtitle {
            font-size: 1.1rem;
            color: var(--text-secondary);
            margin-bottom: 30px;
        }

        .completion-stats {
            display: flex;
            gap: 40px;
            margin-bottom: 35px;
        }

        .completion-stat-value { font-size: 2.5rem; font-weight: 700; display: block; }
        .completion-stat-label { font-family: 'Space Mono', monospace; font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; }

        .completion-actions { display: flex; gap: 12px; }

        .completion-btn {
            padding: 14px 30px;
            border-radius: 10px;
            font-family: 'Space Mono', monospace;
            font-size: 0.85rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }

        .completion-btn.primary { background: var(--accent-gold); border: none; color: var(--bg-primary); }
        .completion-btn.secondary { background: transparent; border: 2px solid var(--border); color: var(--text-primary); }
        .completion-btn:hover { transform: translateY(-2px); }

        /* Start Overlay */
        .start-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            flex-direction: column;
            text-align: center;
            padding: 40px;
        }

        .start-overlay.hidden { display: none; }

        .start-icon {
            font-size: 5rem;
            margin-bottom: 20px;
            animation: heartbeat 1.5s ease-in-out infinite;
        }

        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            15% { transform: scale(1.15); }
            30% { transform: scale(1); }
            45% { transform: scale(1.1); }
        }

        .start-title {
            font-size: 2.8rem;
            font-weight: 700;
            margin-bottom: 15px;
            background: linear-gradient(135deg, var(--accent-blood), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .start-subtitle {
            font-size: 1.15rem;
            color: var(--text-secondary);
            margin-bottom: 35px;
            max-width: 480px;
            line-height: 1.6;
        }

        .start-btn {
            padding: 18px 50px;
            background: linear-gradient(135deg, var(--accent-blood), #b91c1c);
            border: none;
            border-radius: 12px;
            color: white;
            font-family: 'Space Mono', monospace;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .start-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(220, 38, 38, 0.3);
        }

        /* Server Required Notice */
        .server-notice {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            z-index: 9999;
            padding: 40px;
        }

        .server-notice.show { display: block; }

        .server-box {
            max-width: 550px;
            margin: 50px auto;
            background: var(--bg-card);
            border-radius: 16px;
            padding: 35px;
            border: 1px solid var(--border);
        }

        .server-box h1 { color: var(--accent-gold); margin-bottom: 15px; }
        .server-box p { color: var(--text-secondary); line-height: 1.6; margin-bottom: 12px; }
        .server-box code { background: var(--bg-primary); padding: 3px 8px; border-radius: 4px; font-family: 'Space Mono', monospace; color: var(--accent-oxygen); }
        .server-box .code-block { background: var(--bg-primary); padding: 18px; border-radius: 8px; margin: 18px 0; font-family: 'Space Mono', monospace; color: var(--success); }

        /* Audio Controls */
        .audio-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-primary);
            font-size: 1.2rem;
            cursor: pointer;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .audio-toggle:hover { background: var(--bg-secondary); }
        .audio-toggle.muted { color: var(--text-muted); }

        /* Responsive */
        @media (max-width: 1000px) {
            .quiz-page, .discovery-page {
                grid-template-columns: 1fr;
                grid-template-rows: 50vh auto;
            }

            .completion-stats { flex-direction: column; gap: 15px; }
        }
    </style>
</head>
<body>

<!-- Server Required Notice -->
<div class="server-notice" id="server-notice">
    <div class="server-box">
        <h1>‚ö†Ô∏è Local Server Required</h1>
        <p>Sketchfab API requires running from a web server.</p>
        <p>Quick start with Python:</p>
        <div class="code-block">python -m http.server 8000</div>
        <p>Then open: <code>http://localhost:8000</code></p>
    </div>
</div>

<!-- Start Overlay -->
<div class="start-overlay" id="start-overlay">
    <div class="start-icon">ü´Ä</div>
    <h1 class="start-title">Cardiac Cycle Journey</h1>
    <p class="start-subtitle"><strong>You are a red blood cell.</strong> Depleted of oxygen, you must navigate through the heart to reach the lungs and survive. Time is running out...</p>
    <button class="start-btn" id="start-btn">Begin Journey</button>
</div>

<!-- Navigation -->
<nav class="nav-container">
    <div class="nav-tabs">
        <button class="nav-tab active" data-page="quiz">üéÆ Story</button>
        <button class="nav-tab" data-page="leaderboard">üèÜ Leaderboard</button>
        <button class="nav-tab" data-page="discovery">üîç Explore</button>
    </div>
</nav>

<!-- Main Content -->
<main class="main-content">

    <!-- Quiz Page -->
    <div class="page active" id="page-quiz">
        <div class="quiz-page">
            <div class="viewer-panel">
                <div class="loading-overlay" id="loading">
                    <div class="loader"></div>
                    <p class="loading-text">Loading 3D Heart Model...</p>
                </div>
                <div class="vignette-overlay" id="vignette"></div>
                <iframe id="api-frame" 
                        allow="autoplay; fullscreen; xr-spatial-tracking"
                        allowfullscreen
                        mozallowfullscreen="true"
                        webkitallowfullscreen="true">
                </iframe>
            </div>

            <div class="story-panel">
                <!-- Oxygen Vital Signs -->
                <div class="vital-signs" id="vital-signs">
                    <div class="vital-header">
                        <div class="vital-label">
                            <span>ü©∏</span> OXYGEN SATURATION
                        </div>
                        <div class="vital-percent" id="oxygen-percent">100%</div>
                    </div>
                    <div class="oxygen-bar-container">
                        <div class="oxygen-fill" id="oxygen-fill" style="width: 100%;"></div>
                    </div>
                    <div class="status-text" id="status-text">Stable ‚Äî Find your path through the heart</div>
                </div>

                <!-- Progress -->
                <div class="progress-container">
                    <div class="progress-label">
                        <span>Journey Progress</span>
                        <span id="progress-text">0 / 6</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Story Content -->
                <div class="story-phase" id="story-phase">Chapter 1</div>
                <h2 class="story-title" id="story-title"></h2>
                <p class="story-narrative" id="story-narrative"></p>
                <div class="story-instruction" id="story-instruction">
                    Find the <span class="target" id="target-name">target</span> to continue
                </div>

                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="action-btn hint" id="hint-btn">üí° Hint (-50 pts)</button>
                    <button class="action-btn skip" id="skip-btn">‚è≠ Skip (-100 pts)</button>
                </div>

                <!-- Feedback -->
                <div class="feedback-box" id="feedback">
                    <span class="feedback-icon"></span>
                    <span class="feedback-text">Click an annotation on the 3D heart</span>
                </div>

                <!-- Stats -->
                <div class="stats-row">
                    <div class="stat-item">
                        <div class="stat-label">Score</div>
                        <div class="stat-value score" id="score">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Time</div>
                        <div class="stat-value time" id="timer">0:00</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Streak</div>
                        <div class="stat-value streak" id="streak">0üî•</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaderboard Page -->
    <div class="page" id="page-leaderboard">
        <div class="leaderboard-page">
            <div class="leaderboard-header">
                <h1>üèÜ Leaderboard</h1>
                <p style="color: var(--text-muted);">Top survivors of the Cardiac Journey</p>
            </div>

            <div class="podium">
                <div class="podium-place">
                    <div class="podium-avatar">ü•à</div>
                    <div class="podium-name" id="p2-name">---</div>
                    <div class="podium-score" id="p2-score">-</div>
                    <div class="podium-stand">2</div>
                </div>
                <div class="podium-place">
                    <div class="podium-avatar">üëë</div>
                    <div class="podium-name" id="p1-name">---</div>
                    <div class="podium-score" id="p1-score">-</div>
                    <div class="podium-stand">1</div>
                </div>
                <div class="podium-place">
                    <div class="podium-avatar">ü•â</div>
                    <div class="podium-name" id="p3-name">---</div>
                    <div class="podium-score" id="p3-score">-</div>
                    <div class="podium-stand">3</div>
                </div>
            </div>

            <div class="leaderboard-table" id="leaderboard-table"></div>

            <div class="score-entry" id="score-entry">
                <h3>üéâ Submit Your Score</h3>
                <div class="name-input-row">
                    <input type="text" class="name-input" id="player-name" placeholder="Enter your name..." maxlength="20">
                    <button class="submit-btn" id="submit-btn">Submit</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Discovery Page -->
    <div class="page" id="page-discovery">
        <div class="discovery-page">
            <div class="viewer-panel">
                <iframe id="discovery-frame"
                        allow="autoplay; fullscreen; xr-spatial-tracking"
                        allowfullscreen
                        mozallowfullscreen="true"
                        webkitallowfullscreen="true"
                        style="width: 100%; height: 100%; border: none;">
                </iframe>
            </div>
            <div class="discovery-panel">
                <h2>üîç Explore The Heart</h2>
                <p>Learn the heart's anatomy before your journey. Click any annotation below to fly to that structure.</p>
                
                <div class="annotation-list" id="annotation-list">
                    <p style="color: var(--text-muted); text-align: center; padding: 20px;">
                        Loading annotations...
                    </p>
                </div>
            </div>
        </div>
    </div>

</main>

<!-- Game Over Overlay -->
<div class="gameover-overlay" id="gameover-overlay">
    <div class="gameover-icon">üíÄ</div>
    <h1 class="gameover-title">Oxygen Depleted</h1>
    <p class="gameover-subtitle">Your blood cell couldn't find the path in time. The journey ends here... but you can try again.</p>
    <button class="gameover-btn" id="retry-btn">Try Again</button>
</div>

<!-- Completion Overlay -->
<div class="completion-overlay" id="completion-overlay">
    <div class="completion-icon">üéâ</div>
    <h1 class="completion-title">Journey Complete!</h1>
    <p class="completion-subtitle">You survived the cardiac cycle and delivered oxygen to the body!</p>
    
    <div class="completion-stats">
        <div>
            <span class="completion-stat-value" id="final-score" style="color: var(--success)">0</span>
            <span class="completion-stat-label">Points</span>
        </div>
        <div>
            <span class="completion-stat-value" id="final-time" style="color: var(--accent-purple)">0:00</span>
            <span class="completion-stat-label">Time</span>
        </div>
        <div>
            <span class="completion-stat-value" id="final-oxygen" style="color: var(--accent-oxygen)">0%</span>
            <span class="completion-stat-label">Oxygen Left</span>
        </div>
    </div>

    <div class="completion-actions">
        <button class="completion-btn primary" id="save-btn">Save Score</button>
        <button class="completion-btn secondary" id="replay-btn">Play Again</button>
    </div>
</div>

<!-- Audio Toggle -->
<button class="audio-toggle" id="audio-toggle">üîä</button>
<script>
    // =============================================
    // CHECK FOR FILE:// PROTOCOL
    // =============================================
    if (window.location.protocol === 'file:') {
        document.getElementById('server-notice').classList.add('show');
    }

    // =============================================
    // CONFIGURATION
    // =============================================
    const MODEL_UID = 'a3f0ea2030214a6bbaa97e7357eebd58';
    
    // Story Data
    const storyChapters = [
        {
            chapter: "Chapter 1",
            title: "The Arrival",
            narrative: "You drift through darkness, exhausted and oxygen-depleted. The walls of the Superior Vena Cava guide you downward. Ahead, you sense an opening ‚Äî the doorway into the heart's first chamber.",
            target: "Right Atrium",
            keywords: ["right atrium", "atrium", "auricle"],
            points: 150,
            oxygenDrain: 2
        },
        {
            chapter: "Chapter 2",
            title: "The First Chamber",
            narrative: "You've entered the Right Atrium. Other blood cells swirl around you in this crowded holding chamber. The pressure is building. You must find the valve that leads deeper into the heart.",
            target: "Tricuspid Valve",
            keywords: ["tricuspid", "valve", "right atrioventricular"],
            points: 150,
            oxygenDrain: 2.5
        },
        {
            chapter: "Chapter 3",
            title: "The Descent",
            narrative: "The Tricuspid Valve opens! You're pushed through into the Right Ventricle. The walls here are thick and muscular. You can feel them preparing to contract. Find the exit before you're crushed!",
            target: "Pulmonary Valve",
            keywords: ["pulmonary valve", "pulmonic", "semilunar"],
            points: 200,
            oxygenDrain: 3
        },
        {
            chapter: "Chapter 4",
            title: "Escape to the Lungs",
            narrative: "CONTRACTION! The ventricle squeezes with tremendous force. You're launched upward through the Pulmonary Valve into the Pulmonary Artery. Freedom! The lungs await ‚Äî find the artery that will carry you there.",
            target: "Pulmonary Artery",
            keywords: ["pulmonary artery", "pulmonary trunk", "pulmonary"],
            points: 200,
            oxygenDrain: 2
        },
        {
            chapter: "Chapter 5",
            title: "Rebirth",
            narrative: "You've reached the lungs and absorbed fresh oxygen. Your hemoglobin glows bright red with life! Now you must return to the heart through the Pulmonary Veins to complete your mission.",
            target: "Left Atrium",
            keywords: ["left atrium", "atrium", "pulmonary vein"],
            points: 150,
            oxygenDrain: 1.5
        },
        {
            chapter: "Chapter 6",
            title: "The Final Push",
            narrative: "The Left Ventricle ‚Äî the most powerful chamber of all. Its thick walls will launch you into the Aorta with enough force to reach every corner of the body. Find the great artery. Complete your journey!",
            target: "Aorta",
            keywords: ["aorta", "ascending aorta", "aortic"],
            points: 250,
            oxygenDrain: 3
        }
    ];

    // =============================================
    // STATE VARIABLES
    // =============================================
    let api = null;
    let apiDiscovery = null;
    let annotationData = [];
    let currentStep = 0;
    let score = 0;
    let streak = 0;
    let timerInterval = null;
    let oxygenInterval = null;
    let elapsedSeconds = 0;
    let oxygen = 100;
    
    // Flags for Game Logic
    let gameStarted = false;
    let gameComplete = false;
    let hintUsed = false;
    let audioEnabled = true;
    
    // BUG FIX: Prevent event spam
    let isProcessingInput = false; 
    let ignoreNextSelection = false; 

    // Audio context
    let audioContext = null;
    let heartbeatInterval = null;

    // Leaderboard Data
    let leaderboard = JSON.parse(localStorage.getItem('cardiacLeaderboard')) || [
        { name: "Dr. Heart", score: 950, time: "1:32" },
        { name: "CardioKing", score: 820, time: "1:58" },
        { name: "BloodCell", score: 780, time: "2:15" },
        { name: "Anatomist", score: 720, time: "2:40" },
        { name: "MedStudent", score: 650, time: "3:05" }
    ];

    // =============================================
    // AUDIO ENGINE
    // =============================================
    function initAudio() {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        audioContext = new AudioContext();
    }

    function playHeartbeat() {
        if (!audioContext || !audioEnabled) return;
        if (audioContext.state === 'suspended') audioContext.resume();

        // Simple synthetic heartbeat
        const now = audioContext.currentTime;
        
        // "Lub"
        const osc1 = audioContext.createOscillator();
        const gain1 = audioContext.createGain();
        osc1.connect(gain1);
        gain1.connect(audioContext.destination);
        osc1.frequency.setValueAtTime(60, now);
        gain1.gain.setValueAtTime(0.3, now);
        gain1.gain.exponentialRampToValueAtTime(0.001, now + 0.15);
        osc1.start(now);
        osc1.stop(now + 0.15);

        // "Dub"
        const osc2 = audioContext.createOscillator();
        const gain2 = audioContext.createGain();
        osc2.connect(gain2);
        gain2.connect(audioContext.destination);
        osc2.frequency.setValueAtTime(50, now + 0.15);
        gain2.gain.setValueAtTime(0.2, now + 0.15);
        gain2.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
        osc2.start(now + 0.15);
        osc2.stop(now + 0.3);
    }

    function startHeartbeat(bpm = 70) {
        stopHeartbeat();
        const interval = 60000 / bpm;
        playHeartbeat(); // Play immediately
        heartbeatInterval = setInterval(playHeartbeat, interval);
    }

    function stopHeartbeat() {
        if (heartbeatInterval) {
            clearInterval(heartbeatInterval);
            heartbeatInterval = null;
        }
    }

    // Audio Toggle Listener
    document.getElementById('audio-toggle').addEventListener('click', () => {
        audioEnabled = !audioEnabled;
        const btn = document.getElementById('audio-toggle');
        btn.textContent = audioEnabled ? 'üîä' : 'üîá';
        btn.classList.toggle('muted', !audioEnabled);
        
        if (audioEnabled && gameStarted && !gameComplete) {
            startHeartbeat();
        } else {
            stopHeartbeat();
        }
    });

    // =============================================
    // NAVIGATION & SETUP
    // =============================================
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            tab.classList.add('active');
            document.getElementById(`page-${tab.dataset.page}`).classList.add('active');

            if (tab.dataset.page === 'leaderboard') renderLeaderboard();
            if (tab.dataset.page === 'discovery' && !apiDiscovery) initDiscoveryViewer();
        });
    });

    document.getElementById('start-btn').addEventListener('click', () => {
        document.getElementById('start-overlay').classList.add('hidden');
        initAudio();
        initSketchfab();
    });

    // =============================================
    // SKETCHFAB INTEGRATION
    // =============================================
    function initSketchfab() {
        const iframe = document.getElementById('api-frame');
        const client = new Sketchfab(iframe);

        client.init(MODEL_UID, {
            success: function(apiInstance) {
                api = apiInstance;
                api.start();
                api.addEventListener('viewerready', function() {
                    document.getElementById('loading').classList.add('hidden');
                    
                    api.getAnnotationList(function(err, annotations) {
                        if (!err && annotations.length > 0) {
                            annotationData = annotations;
                        }
                        startGame();
                    });

                    // EVENT LISTENER
                    api.addEventListener('annotationSelect', function(index) {
                        // BUG FIX: Ignore invalid, programmatic, or locked selections
                        if (index === -1) return; 
                        if (ignoreNextSelection) {
                            ignoreNextSelection = false;
                            return;
                        }
                        if (!gameStarted || gameComplete || isProcessingInput) return;

                        checkAnnotationAnswer(index);
                    });
                });
            },
            error: function() { console.error('Viewer error'); },
            autostart: 0,
            annotations_visible: 1,
            ui_annotations: 1,
            ui_watermark: 0,
            ui_hint: 0 // Hide built-in hints
        });
    }

    // =============================================
    // GAMEPLAY LOGIC
    // =============================================
    function startGame() {
        gameStarted = true;
        gameComplete = false;
        currentStep = 0;
        score = 0;
        streak = 0;
        elapsedSeconds = 0;
        oxygen = 100;
        
        updateStats();
        updateOxygenUI();
        
        // Timers
        clearInterval(timerInterval);
        clearInterval(oxygenInterval);
        timerInterval = setInterval(() => {
            elapsedSeconds++;
            document.getElementById('timer').textContent = formatTime(elapsedSeconds);
        }, 1000);
        
        oxygenInterval = setInterval(drainOxygen, 1000);
        
        if (audioEnabled) startHeartbeat(70);
        
        playChapter(0);
    }

    function playChapter(index) {
        // Unlock input
        isProcessingInput = false;
        
        const chapter = storyChapters[index];
        
        document.getElementById('story-phase').textContent = chapter.chapter;
        
        // Reset Hints
        hintUsed = false;
        const hintBtn = document.getElementById('hint-btn');
        hintBtn.classList.remove('used');
        hintBtn.textContent = 'üí° Hint (-50 pts)';

        resetFeedback();

        // Update Progress
        const progress = (index / storyChapters.length) * 100;
        document.getElementById('progress-fill').style.width = `${progress}%`;
        document.getElementById('progress-text').textContent = `${index} / ${storyChapters.length}`;
        
        document.getElementById('target-name').textContent = chapter.target;

        // Typewriter Effect
        const titleEl = document.getElementById('story-title');
        const narrativeEl = document.getElementById('story-narrative');
        
        // Clear previous text immediately
        titleEl.innerHTML = '';
        narrativeEl.innerHTML = '';

        typeWriter(chapter.title, 'story-title', 40, () => {
            typeWriter(chapter.narrative, 'story-narrative', 20);
        });

        // BUG FIX: Removed moveCameraToTarget(chapter) call.
        // Moving the camera to the target immediately spoils the game AND causes the loop bug.
        // Instead, we deselect any active annotation to start fresh.
        if (api) {
            api.deselectAnnotation(); 
        }
    }

    function checkAnnotationAnswer(selectedIndex) {
        // Lock input to prevent spam
        isProcessingInput = true;

        const chapter = storyChapters[currentStep];
        const selectedAnn = annotationData[selectedIndex];
        
        // Safety check
        if (!selectedAnn) {
            isProcessingInput = false;
            return;
        }

        const selectedName = (selectedAnn.name || '').toLowerCase();
        
        // Check keywords
        const isCorrect = chapter.keywords.some(kw => selectedName.includes(kw.toLowerCase()));

        if (isCorrect) {
            handleCorrectAnswer(chapter);
        } else {
            handleWrongAnswer(selectedAnn.name);
        }
    }

    function handleCorrectAnswer(chapter) {
        streak++;
        const streakBonus = Math.min(streak - 1, 5) * 30;
        const oxygenBonus = Math.round(oxygen / 2);
        const earned = chapter.points + streakBonus + oxygenBonus;
        score += earned;
        oxygen = Math.min(100, oxygen + 15);

        updateStats();
        updateOxygenUI();
        showFeedback(true, `Correct! +${earned} pts`);
        
        // Delay before next chapter
        currentStep++;
        
        if (currentStep >= storyChapters.length) {
            setTimeout(completeGame, 1500);
        } else {
            setTimeout(() => {
                playChapter(currentStep);
            }, 2000);
        }
    }

    function handleWrongAnswer(clickedName) {
        streak = 0;
        oxygen -= 5;
        updateOxygenUI();
        updateStats();
        showFeedback(false, `"${clickedName}" is incorrect. -5% Oxygen`);
        
        // Unlock input immediately so they can try again
        isProcessingInput = false;
    }

    // =============================================
    // UTILITIES
    // =============================================
    function typeWriter(text, elementId, speed, callback) {
        const element = document.getElementById(elementId);
        let i = 0;
        
        // Basic Typewriter
        function type() {
            if (i < text.length) {
                element.innerHTML += text.charAt(i);
                i++;
                setTimeout(type, speed);
            } else {
                if(callback) callback();
            }
        }
        type();
    }

    function drainOxygen() {
        if (!gameStarted || gameComplete) return;
        
        const chapter = storyChapters[currentStep];
        oxygen -= chapter.oxygenDrain;
        if (oxygen <= 0) {
            oxygen = 0;
            gameOver();
        }
        updateOxygenUI();
    }

    function updateOxygenUI() {
        const fill = document.getElementById('oxygen-fill');
        const percent = document.getElementById('oxygen-percent');
        const vital = document.getElementById('vital-signs');
        const status = document.getElementById('status-text');

        fill.style.width = `${Math.max(0, oxygen)}%`;
        percent.textContent = `${Math.round(oxygen)}%`;

        if (oxygen < 30) {
            fill.style.background = '#ef4444';
            vital.classList.add('critical');
            status.textContent = '‚ö†Ô∏è CRITICAL CONDITION';
            status.classList.add('urgent');
            startHeartbeat(130); // Fast heartbeat
        } else {
            fill.style.background = 'linear-gradient(90deg, #ef4444, #3b82f6)';
            vital.classList.remove('critical');
            status.textContent = 'Stable condition';
            status.classList.remove('urgent');
            startHeartbeat(70); // Normal heartbeat
        }
    }

    function formatTime(sec) {
        const m = Math.floor(sec / 60);
        const s = sec % 60;
        return `${m}:${s.toString().padStart(2, '0')}`;
    }

    function showFeedback(isCorrect, text) {
        const box = document.getElementById('feedback');
        box.className = `feedback-box ${isCorrect ? 'correct' : 'wrong'}`;
        box.querySelector('.feedback-text').textContent = text;
        box.querySelector('.feedback-icon').textContent = isCorrect ? '‚úì' : '‚úó';
    }

    function resetFeedback() {
        const box = document.getElementById('feedback');
        box.className = 'feedback-box';
        box.querySelector('.feedback-text').textContent = 'Click an annotation on the 3D heart';
        box.querySelector('.feedback-icon').textContent = '';
    }

    function updateStats() {
        document.getElementById('score').textContent = score;
        document.getElementById('streak').textContent = `${streak}üî•`;
    }

    // =============================================
    // HINT SYSTEM
    // =============================================
    document.getElementById('hint-btn').addEventListener('click', () => {
        if (hintUsed || !api || isProcessingInput) return;

        const chapter = storyChapters[currentStep];
        // Find index of target
        const targetIndex = annotationData.findIndex(ann => 
            chapter.keywords.some(kw => (ann.name || '').toLowerCase().includes(kw.toLowerCase()))
        );

        if (targetIndex >= 0) {
            hintUsed = true;
            score = Math.max(0, score - 50);
            updateStats();
            document.getElementById('hint-btn').classList.add('used');
            document.getElementById('hint-btn').textContent = 'Hint Used';

            // BUG FIX: Set flag to ignore the event generated by camera movement
            ignoreNextSelection = true;
            
            api.gotoAnnotation(targetIndex, { preventCameraAnimation: false }, () => {
                showFeedback(false, "Camera moved to target area. (-50 pts)");
            });
        }
    });

    // =============================================
    // SKIP SYSTEM
    // =============================================
    document.getElementById('skip-btn').addEventListener('click', () => {
        if (isProcessingInput) return;
        score = Math.max(0, score - 100);
        streak = 0;
        updateStats();
        
        // Briefly lock input
        isProcessingInput = true;
        
        showFeedback(false, "Skipped (-100 pts)");
        
        currentStep++;
        if (currentStep >= storyChapters.length) {
            completeGame();
        } else {
            setTimeout(() => playChapter(currentStep), 1000);
        }
    });

    // =============================================
    // END GAME LOGIC
    // =============================================
    function gameOver() {
        gameComplete = true;
        clearInterval(timerInterval);
        clearInterval(oxygenInterval);
        stopHeartbeat();
        document.getElementById('gameover-overlay').classList.add('show');
    }

    function completeGame() {
        gameComplete = true;
        clearInterval(timerInterval);
        clearInterval(oxygenInterval);
        stopHeartbeat();
        
        document.getElementById('final-score').textContent = score;
        document.getElementById('final-time').textContent = formatTime(elapsedSeconds);
        document.getElementById('final-oxygen').textContent = `${Math.round(oxygen)}%`;
        
        document.getElementById('completion-overlay').classList.add('show');
        document.getElementById('score-entry').classList.add('show');
    }

    document.getElementById('retry-btn').addEventListener('click', () => {
        document.getElementById('gameover-overlay').classList.remove('show');
        startGame();
    });

    document.getElementById('replay-btn').addEventListener('click', () => {
        document.getElementById('completion-overlay').classList.remove('show');
        startGame();
    });

    // =============================================
    // LEADERBOARD & DISCOVERY
    // =============================================
    function renderLeaderboard() {
        leaderboard.sort((a,b) => b.score - a.score);
        // Fill top 3
        if(leaderboard[0]) {
            document.getElementById('p1-name').textContent = leaderboard[0].name;
            document.getElementById('p1-score').textContent = leaderboard[0].score;
        }
        if(leaderboard[1]) {
            document.getElementById('p2-name').textContent = leaderboard[1].name;
            document.getElementById('p2-score').textContent = leaderboard[1].score;
        }
        if(leaderboard[2]) {
            document.getElementById('p3-name').textContent = leaderboard[2].name;
            document.getElementById('p3-score').textContent = leaderboard[2].score;
        }
        
        // Fill Table
        const table = document.getElementById('leaderboard-table');
        table.innerHTML = leaderboard.slice(3).map((p, i) => `
            <div class="leaderboard-row">
                <span class="rank">${i+4}</span>
                <div class="player-info">
                    <span class="player-name">${p.name}</span>
                </div>
                <span class="player-score">${p.score}</span>
                <span class="player-time">${p.time}</span>
            </div>
        `).join('');
    }

    document.getElementById('submit-btn').addEventListener('click', () => {
        const name = document.getElementById('player-name').value || 'Anonymous';
        leaderboard.push({ name, score, time: formatTime(elapsedSeconds) });
        localStorage.setItem('cardiacLeaderboard', JSON.stringify(leaderboard));
        document.getElementById('score-entry').classList.remove('show');
        renderLeaderboard();
    });

    function initDiscoveryViewer() {
        const iframe = document.getElementById('discovery-frame');
        const client = new Sketchfab(iframe);
        client.init(MODEL_UID, {
            success: function(inst) {
                apiDiscovery = inst;
                apiDiscovery.start();
                apiDiscovery.addEventListener('viewerready', () => {
                    apiDiscovery.getAnnotationList((err, anns) => {
                        if(!err) displayAnnotations(anns);
                    });
                });
            },
            autostart: 1, 
            ui_watermark: 0
        });
    }

    function displayAnnotations(anns) {
        const list = document.getElementById('annotation-list');
        list.innerHTML = anns.map((a, i) => `
            <div class="annotation-item" onclick="moveDiscoveryCam(${i})">
                <div class="index">${i+1}</div>
                <div class="title">${a.name}</div>
            </div>
        `).join('');
    }
    
    // Global scope for HTML onclick
    window.moveDiscoveryCam = function(index) {
        if(apiDiscovery) apiDiscovery.gotoAnnotation(index);
    }
</script>